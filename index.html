<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tesla Serve Key — Instructions</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width: 900px; margin: 2rem auto; padding: 0 1rem; line-height:1.5; }
    pre { background:#f6f8fa; padding:1rem; overflow:auto; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }
    h1,h2 { margin-top:1.4rem; }
  </style>
</head>
<body>
  <h1>Tesla Serve Key — Quick Setup</h1>
  <p>
    This page documents how to serve a Tesla public key from Home Assistant so it is available at:
    <code>/.well-known/appspecific/com.tesla.3p.public-key.pem</code>
  </p>

  <h2>Steps</h2>
  <ol>
    <li>Place your public key file in the Home Assistant <code>/config</code> directory with one of these names (checked in order):
      <ul>
        <li><code>tesla-public-key.pem</code> (recommended)</li>
        <li><code>.tesla/tesla-public-key.pem</code> (in a hidden .tesla directory)</li>
        <li><code>tesla_fleet_public_key.pem</code> (alternative name)</li>
      </ul>
    </li>
    <li>Create <code>custom_components/tesla_serve_key/</code> under <code>/config</code> and add the integration files:</li>
  </ol>

  <h3><code>__init__.py</code></h3>
  <pre><code>import logging
import os

from homeassistant.components.http import StaticPathConfig

DOMAIN = "tesla_serve_key"

_LOGGER = logging.getLogger(__name__)

# Priority-ordered list of possible PEM file locations
PEM_FILE_LOCATIONS = [
    "/config/tesla-public-key.pem",
    "/config/.tesla/tesla-public-key.pem",
    "/config/tesla_fleet_public_key.pem",
]


def find_pem_file():
    """Find the first existing PEM file from the list of possible locations."""
    for pem_path in PEM_FILE_LOCATIONS:
        if os.path.isfile(pem_path):
            _LOGGER.info("Found Tesla PEM file at: %s", pem_path)
            return pem_path
    
    _LOGGER.error(
        "Tesla PEM file not found in any of the expected locations: %s",
        ", ".join(PEM_FILE_LOCATIONS)
    )
    return None


async def async_setup(hass, config):
    """Set up the Tesla Serve Key integration."""
    pem_file_path = find_pem_file()
    
    if pem_file_path is None:
        _LOGGER.error(
            "Cannot set up Tesla Serve Key: PEM file not found. "
            "Please place your Tesla public key file in one of these locations: %s",
            ", ".join(PEM_FILE_LOCATIONS)
        )
        return False
    
    await hass.http.async_register_static_paths(
        [
            StaticPathConfig(
                "/.well-known/appspecific/com.tesla.3p.public-key.pem",
                pem_file_path,
                False,
            )
        ]
    )
    
    _LOGGER.info(
        "Tesla Serve Key integration set up successfully. "
        "Serving PEM from: /.well-known/appspecific/com.tesla.3p.public-key.pem"
    )
    
    return True
</code></pre>

  <h3><code>manifest.json</code></h3>
  <pre><code>{
  "domain": "tesla_serve_key",
  "name": "Tesla Serve Key",
  "version": "0.2.0"
}
</code></pre>

  <ol start="3">
    <li>Add the integration entry to <code>configuration.yaml</code>:</li>
  </ol>
  <pre><code>tesla_serve_key:</code></pre>

  <ol start="4">
    <li>Restart Home Assistant.</li>
    <li>Confirm the key is served at:
      <code>https://yourdomain.tld/.well-known/appspecific/com.tesla.3p.public-key.pem</code>
    </li>
  </ol>

  <p>Instructions adapted from a Home Assistant discussion: <a href="https://github.com/home-assistant/core/issues/135116#issuecomment-2609041270">https://github.com/home-assistant/core/issues/135116#issuecomment-2609041270</a></p>
</body>
</html>
